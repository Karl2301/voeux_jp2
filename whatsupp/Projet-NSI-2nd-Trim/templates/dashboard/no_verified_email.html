<!DOCTYPE html>
<html lang="fr" >
<head>
  <meta charset="UTF-8">
  <title>Verifie ton email</title>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/high_admin_panel/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/high_admin_panel/lineicons.css') }}" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/high_admin_panel/materialdesignicons.min.css') }}" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/high_admin_panel/fullcalendar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/login/main.css') }}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo_projet.png') }}"/>
</head>

<body>
  <div class="container">
    <div class="nav">
        <ul>
            <li><img width="25px" height="25px" src="{{ url_for('static', filename='img/logo_projet.png') }}"/> WhatsUpp<span class="blue">.</span></li>
            <li class="gray">A propos</li>
            
        </ul>
    </div>
    <div class="hero">
        <div class="text">
            <p class="gray">Une petite vérification..</p>
            <h1>Confirmation par E-mail<span class="blue">.</span></h1>
            <p class="gray">Vous n'avez rien reçu ? <a class="blue" href="/"><span class="blue">Contactez-nous</span></a></p>
        </div>
        <div class="form">
            <div classf="id">
                <div class="input-icons">
                    <legend for="email">Code OTP</legend>
                    <div class="icon-center">
                        <input class="input" id="otp_input" type="text" minlength="6" maxlength="6" pattern="\d*" placeholder="Entrez le code de vérification">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-person-lines-fill" viewBox="0 0 16 16">
                                <path
                                    d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-5 6s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H1zM11 3.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5zm.5 2.5a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1h-4zm2 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1h-2zm0 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1h-2z" />
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="buttons">
                <button onclick="VerifEmail()" class="btn blue-btn" >Confirmer mon compte</button>
            </div>
        </div>
    </div>
    <div class="footer">
        NSI
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
    // Récupérer l'ID de l'utilisateur courant
        fetch('/get_user_id')
        .then(response => response.json())
        .then(data => {
            console.log(data)
            var socket = io.connect('https://' + document.domain + ':' + location.port);
            var userId = data.user_id;
            
            socket.on('connect', function() {
                socket.emit('join', { user_id: userId });
            });

            socket.on('verified_email_ok', function(data) {
                if(data.status == true) {
                    location.reload();
                }
            });

            console.log("WebSocket connecté !");
        });

        var inputField = document.getElementById('otp_input');
        inputField.addEventListener('keydown', function(event) { 
        
          if (event.key === 'Enter') {
            VerifEmail();
          }
        });

    });

    function VerifEmail() {
    var otp_num = document.getElementById('otp_input').value;
    console.log(otp_num);
    otp_string = otp_num.toString();
    if (otp_string.length != 6) {
        alert("Le code de vérification doit contenir 6 chiffres");
        return;
    }
    console.log(JSON.stringify({ otp_verif_code: otp_num }))
    fetch('/otp_verif', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ otp_verif_code: otp_num })
    })
    .then(response => response.json())
    .then(data => {
      console.log(data)
      if(data.success == false) {
          alert("Code de vérification incorrect");
      } else if(data.success == true) {
          location.reload();
      }
    })
    .catch((error) => {
        console.error('Erreur:', error);
    });
}
</script>
</body>  
</html>
